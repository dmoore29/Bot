<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>David's Purchasing Bot Configuration</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">David's Purchasing Bot Configuration</h1>

        <!-- Controls for Start, Stop, and Status -->
        <div class="text-center mb-4">
            <button class="btn btn-success" id="startButton">Start</button>
            <button class="btn btn-danger" id="stopButton">Stop</button>
            <button class="btn btn-info" id="statusButton">Check Status</button>
        </div>
        
        <div class="form-group">
            <label for="retryInterval">Retry Interval (seconds)</label>
            <input type="number" class="form-control" id="retryInterval" value="${configuration.retryInterval || 10}" onchange="updateRetryInterval(this.value)">
        </div>

        <div id="productList"></div>
        <button class="btn btn-success" id="addProductButton">Add New Product</button>
        <button class="btn btn-primary" id="saveButton">Save Configuration</button>
    </div>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1216.0.min.js"></script>
    <script>
        AWS.config.region = 'us-east-1';
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'us-east-1:f8f180df-93aa-4811-ab5d-2786fbfacf52'
        });

        const ddb = new AWS.DynamoDB();
        let configuration;

        // Function to fetch configuration from DynamoDB
        function fetchConfiguration() {
            const params = {
                TableName: 'PurchaseBot',
                Key: {
                    'botName': { S: 'finewineandgoodspirits' }
                }
            };

            ddb.getItem(params, function(err, data) {
                if (err) {
                    console.error("Unable to read item. Error JSON:", JSON.stringify(err, null, 2));
                } else {
                    if (data.Item) {
                        configuration = AWS.DynamoDB.Converter.unmarshall(data.Item);
                        renderProducts();
                        document.getElementById("retryInterval").value = configuration.retryInterval; // Set initial retry interval
                    } else {
                        console.error("Item not found in DynamoDB.");
                    }
                }
            });
        }

        // API functions for Start, Stop, and Status
        function startBot() {
            fetch('http://98.83.74.128:5000/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => alert(`Start Bot Response: ${JSON.stringify(data)}`))
                .catch(error => console.error('Error:', error));
        }

        function stopBot() {
            fetch('http://98.83.74.128:5000/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => alert(`Stop Bot Response: ${JSON.stringify(data)}`))
                .catch(error => console.error('Error:', error));
        }

        function checkStatus() {
            fetch('http://98.83.74.128:5000/status')
                .then(response => response.json())
                .then(data => alert(`Bot Status: ${JSON.stringify(data)}`))
                .catch(error => console.error('Error:', error));
        }

        // Function to render products
        function renderProducts() {
            const productList = document.getElementById("productList");
            productList.innerHTML = ""; // Clear previous entries
            configuration.products.forEach((product, index) => {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">Product ${index + 1}</h5>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" class="form-control" value="${product.quantity}" onchange="updateProduct(${index}, 'quantity', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" onchange="updateProduct(${index}, 'status', this.value)">
                                <option value="coming_soon" ${product.status === 'coming_soon' ? 'selected' : ''}>Coming Soon</option>
                                <option value="purchased" ${product.status === 'purchased' ? 'selected' : ''}>Purchased</option>
                                <option value="error" ${product.status === 'error' ? 'selected' : ''}>Error</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Select Input Type</label>
                            <div>
                                <label><input type="radio" name="inputType${index}" value="url" onchange="updateInputType(${index}, 'url')" ${product.url ? 'checked' : ''}> URL</label>
                                <label><input type="radio" name="inputType${index}" value="name" onchange="updateInputType(${index}, 'name')" ${product.name ? 'checked' : ''}> Name</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>${product.url ? 'URL' : 'Name'}</label>
                            <input type="text" class="form-control" value="${product.url || product.name || ''}" 
                            onchange="updateProduct(${index}, '${product.url ? 'url' : 'name'}', this.value)">
                        </div>
                        <button class="btn btn-danger" onclick="removeProduct(${index})">Remove Product</button>
                    </div>
                `;
                productList.appendChild(card);
            });
        }

        // Function to update product information
        function updateProduct(index, field, value) {
            const product = configuration.products[index];

            switch (field) {
                case 'quantity':
                    product.quantity = parseInt(value, 10);
                    break;
                case 'status':
                    product.status = value;
                    break;
                case 'url':
                    product.url = value;
                    product.name = null;
                    break;
                case 'name':
                    product.name = value;
                    product.url = null;
                    break;
                default:
                    console.error("Invalid field for update:", field);
                    return;
            }

            configuration.products[index] = product;
            renderProducts();
        }

        function updateRetryInterval(value) {
            configuration.retryInterval = parseInt(value, 10);
        }

        // Function to update input type and reset the other field
        function updateInputType(index, type) {
            const product = configuration.products[index];
            if (type === 'url') {
                product.url = product.url || " ";
                product.name = null;
            } else {
                product.name = product.name || " ";
                product.url = null;
            }

            configuration.products[index] = product;
            renderProducts();
        }

        // Function to add a new product
        function addProduct() {
            configuration.products.push({
                quantity: 1,
                status: "coming_soon",
                url: " ",
                name: null
            });
            renderProducts();
        }

        // Function to remove a product
        function removeProduct(index) {
            configuration.products.splice(index, 1);
            renderProducts();
        }

        // Function to save configuration to DynamoDB
        function saveConfiguration() {
            const params = {
                TableName: 'PurchaseBot',
                Item: AWS.DynamoDB.Converter.marshall(configuration)
            };

            ddb.putItem(params, function(err) {
                if (err) {
                    console.error("Unable to add item. Error JSON:", JSON.stringify(err, null, 2));
                } else {
                    console.log("Configuration saved:", JSON.stringify(configuration, null, 2));
                    alert("Configuration saved successfully!");
                }
            });
        }

        // Event listeners for buttons
        document.getElementById("addProductButton").addEventListener("click", addProduct);
        document.getElementById("saveButton").addEventListener("click", saveConfiguration);

        // Event listeners for control buttons
        document.getElementById("startButton").addEventListener("click", startBot);
        document.getElementById("stopButton").addEventListener("click", stopBot);
        document.getElementById("statusButton").addEventListener("click", checkStatus);

        // Initial render of products
        window.onload = fetchConfiguration;
    </script>
</body>
</html>
